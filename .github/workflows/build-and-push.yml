name: Build, Scan, and Push Backend Image

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

env:
  GCP_PROJECT_ID: kxnwork
  GCP_REGION: asia-south1
  ARTIFACT_REGISTRY_REPO: backend-app
  IMAGE_NAME: backend-app

permissions:
  id-token: write
  contents: read

jobs:
  build-scan-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Auth to GCP via Workload Identity
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: "projects/382207431122/locations/global/workloadIdentityPools/github-wif-clean/providers/github-provider"
          service_account: "ci-backend-app@kxnwork.iam.gserviceaccount.com"
          create_credentials_file: true
          export_environment_variables: true

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Set image tag (short git SHA)
        id: vars
        run: |
          GIT_SHA=$(git rev-parse --short=7 HEAD)
          echo "tag=${GIT_SHA}" >> "$GITHUB_OUTPUT"

      - name: Build Docker image (no cache)
        run: |
          docker build \
            --no-cache \
            -f docker/Dockerfile \
            -t ${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.tag }} \
            .

      - name: Security scan with Trivy
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: ${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.tag }}
          severity: CRITICAL,HIGH
          exit-code: "1"
          format: "table"

      - name: Tag image for Artifact Registry
        run: |
          docker tag ${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.tag }} \
            ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.tag }}

      - name: Push image to Artifact Registry
        run: |
          docker push \
            ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.tag }}

      - name: Update Helm values with new image tag
        run: |
          sed -i "s/^  tag: \".*\"/  tag: \"${{ steps.vars.outputs.tag }}\"/" deploy/helm/backend-app/values.yaml
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git commit -am "Update image tag to ${{ steps.vars.outputs.tag }}" || echo "No changes to commit"
          git push || echo "No changes to push"
